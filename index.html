<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Monatliche Ausgaben Tracker</title>

    <!-- Manifest + Theme -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#667eea" />
    <!-- iPhone/iPad Icon -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <!-- Fallback favicon -->
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    
    <!-- Dein CSS (wie gegeben) -->
    <style>
        /* (der CSS-Block ist identisch mit deinem Original) */
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width:1200px; margin:0 auto; background:white; border-radius:20px; padding:40px; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; flex-wrap:wrap; gap:20px; }
        h1 { color:#1a202c; font-size:2.5rem; }
        .button-group { display:flex; gap:10px; flex-wrap:wrap; }
        button, .file-label { padding:10px 20px; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.3s; font-size:14px; display:inline-flex; align-items:center; gap:8px; }
        .btn-green { background:#10b981; color:white; } .btn-green:hover { background:#059669; }
        .btn-blue { background:#3b82f6; color:white; } .btn-blue:hover { background:#2563eb; }
        .btn-purple { background:#8b5cf6; color:white; } .btn-purple:hover { background:#7c3aed; }
        .btn-indigo { background:#6366f1; color:white; } .btn-indigo:hover { background:#4f46e5; }
        .btn-red { background:#ef4444; color:white; padding:5px 10px; } .btn-red:hover { background:#dc2626; }
        .file-label { background:#3b82f6; color:white; } .file-label:hover { background:#2563eb; }
        input[type="file"] { display:none; }
        .month-selector { margin-bottom:30px; }
        label { display:block; margin-bottom:8px; color:#374151; font-weight:500; }
        input[type="month"], input[type="number"], input[type="text"], select { padding:12px; border:2px solid #e5e7eb; border-radius:8px; font-size:16px; transition:border-color 0.3s; }
        input:focus, select:focus { outline:none; border-color:#6366f1; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin-bottom:30px; }
        .stat-card { padding:30px; border-radius:16px; color:white; }
        .stat-card.primary { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); }
        .stat-card.secondary { background:white; border:2px solid #e5e7eb; color:#1a202c; }
        .stat-title { font-size:1.1rem; margin-bottom:10px; opacity:0.9; }
        .stat-value { font-size:2.5rem; font-weight:bold; margin-bottom:5px; }
        .stat-subtitle { font-size:0.9rem; opacity:0.8; }
        .category-list { max-height:200px; overflow-y:auto; }
        .category-item { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f3f4f6; }
        .add-expense-section { background:#f9fafb; padding:30px; border-radius:16px; margin-bottom:30px; }
        .add-expense-section h2 { margin-bottom:20px; color:#1a202c; }
        .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; }
        .btn-add { background:#6366f1; color:white; padding:12px 24px; } .btn-add:hover { background:#4f46e5; }
        .expenses-table { background:white; border:2px solid #e5e7eb; border-radius:16px; overflow:hidden; }
        .table-header { padding:20px 30px; border-bottom:2px solid #e5e7eb; }
        .table-header h2 { color:#1a202c; }
        table { width:100%; border-collapse:collapse; }
        thead { background:#f9fafb; }
        th { padding:15px 20px; text-align:left; color:#374151; font-weight:600; font-size:0.9rem; }
        th:last-child { text-align:center; }
        td { padding:15px 20px; border-bottom:1px solid #f3f4f6; }
        tr:hover { background:#f9fafb; }
        .amount { text-align:right; font-weight:600; }
        .action-cell { text-align:center; }
        .empty-state { padding:60px 20px; text-align:center; color:#9ca3af; }
        @media (max-width:768px) {
            .container { padding:20px; }
            h1 { font-size:1.8rem; }
            .header { flex-direction:column; align-items:stretch; }
            .button-group { flex-direction:column; }
            button, .file-label { width:100%; justify-content:center; }
            .form-grid { grid-template-columns:1fr; }
            table { font-size:0.9rem; }
            th, td { padding:10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Monatliche Ausgaben</h1>
            <div class="button-group">
                <button class="btn-green" onclick="exportJSON()">‚¨áÔ∏è JSON Backup</button>
                <label class="file-label">
                    ‚¨ÜÔ∏è JSON Import
                    <input type="file" accept=".json" onchange="importJSON(event)">
                </label>
                <button class="btn-purple" onclick="exportCSV(false)">üìÑ CSV (Monat)</button>
                <button class="btn-indigo" onclick="exportCSV(true)">üìÑ CSV (Alle)</button>
            </div>
        </div>

        <div class="month-selector">
            <label for="monthSelect">Monat ausw√§hlen</label>
            <input type="month" id="monthSelect" onchange="loadExpenses()">
        </div>

        <div class="add-expense-section" style="margin-bottom: 30px;">
            <h2>üí∞ Verf√ºgbares Guthaben</h2>
            <div style="display: flex; gap: 15px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label for="budgetInput">Guthaben f√ºr diesen Monat (‚Ç¨)</label>
                    <input type="number" id="budgetInput" placeholder="z.B. 2000" step="0.01" min="0" style="width: 100%;" onchange="saveBudget()">
                </div>
                <button class="btn-indigo" onclick="saveBudget()">üíæ Speichern</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-title">Gesamtausgaben</div>
                <div class="stat-value" id="totalAmount">0,00 ‚Ç¨</div>
                <div class="stat-subtitle" id="totalCount">0 Eintr√§ge</div>
            </div>

            <div class="stat-card" id="remainingCard" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div class="stat-title">Verbleibendes Guthaben</div>
                <div class="stat-value" id="remainingAmount">0,00 ‚Ç¨</div>
                <div class="stat-subtitle" id="budgetSubtitle">Kein Guthaben festgelegt</div>
            </div>

            <div class="stat-card secondary">
                <div class="stat-title">Nach Kategorien</div>
                <div class="category-list" id="categoryList"></div>
            </div>
        </div>

        <div class="add-expense-section">
            <h2>‚ûï Neue Ausgabe hinzuf√ºgen</h2>
            <div class="form-grid">
                <select id="categorySelect">
                    <option value="">Kategorie w√§hlen</option>
                    <option>Miete/Hypothek</option>
                    <option>Lebensmittel</option>
                    <option>Transport</option>
                    <option>Versicherungen</option>
                    <option>Strom/Gas/Wasser</option>
                    <option>Internet/Telefon</option>
                    <option>Kleidung</option>
                    <option>Gesundheit</option>
                    <option>Freizeit</option>
                    <option>Sonstiges</option>
                </select>

                <input type="number" id="amountInput" placeholder="Betrag (‚Ç¨)" step="0.01" min="0">
                <input type="text" id="descriptionInput" placeholder="Beschreibung (optional)">
                <button class="btn-add" onclick="addExpense()">‚ûï Hinzuf√ºgen</button>
            </div>
        </div>

        <div class="expenses-table">
            <div class="table-header">
                <h2>Alle Ausgaben</h2>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Kategorie</th>
                        <th>Beschreibung</th>
                        <th style="text-align: right;">Betrag</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody id="expensesTableBody">
                    <tr>
                        <td colspan="4" class="empty-state">Noch keine Ausgaben f√ºr diesen Monat erfasst</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Dein JS (wie gegeben) -->
    <script>
        // Service worker registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js').then(function(reg){
                console.log('ServiceWorker registriert.', reg);
            }).catch(function(err){
                console.warn('ServiceWorker-Fehler:', err);
            });
        }

        // Initialisierung
        const monthSelect = document.getElementById('monthSelect');
        const today = new Date();
        monthSelect.value = today.toISOString().slice(0, 7);

        // Daten laden beim Start
        loadExpenses();

        function getBudgetKey() { return `budget-${monthSelect.value}`; }
        function getStorageKey() { return `expenses-${monthSelect.value}`; }

        function loadBudget() {
            const key = getBudgetKey();
            const budget = localStorage.getItem(key);
            document.getElementById('budgetInput').value = budget || '';
        }

        function saveBudget() {
            const budget = parseFloat(document.getElementById('budgetInput').value);
            if (budget && budget > 0) {
                const key = getBudgetKey();
                localStorage.setItem(key, budget);
                loadExpenses();
            } else if (document.getElementById('budgetInput').value === '') {
                const key = getBudgetKey();
                localStorage.removeItem(key);
                loadExpenses();
            }
        }

        function loadExpenses() {
            const key = getStorageKey();
            const data = localStorage.getItem(key);
            const expenses = data ? JSON.parse(data) : [];

            loadBudget();
            updateStats(expenses);
            updateTable(expenses);
        }

        function saveExpenses(expenses) {
            const key = getStorageKey();
            localStorage.setItem(key, JSON.stringify(expenses));
        }

        function addExpense() {
            const category = document.getElementById('categorySelect').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            const description = document.getElementById('descriptionInput').value;

            if (!category || !amount || amount <= 0) {
                alert('Bitte w√§hle eine Kategorie und gib einen g√ºltigen Betrag ein.');
                return;
            }

            const key = getStorageKey();
            const data = localStorage.getItem(key);
            const expenses = data ? JSON.parse(data) : [];

            expenses.push({
                id: Date.now(),
                category: category,
                amount: amount,
                description: description
            });

            saveExpenses(expenses);
            loadExpenses();

            // Formular zur√ºcksetzen
            document.getElementById('categorySelect').value = '';
            document.getElementById('amountInput').value = '';
            document.getElementById('descriptionInput').value = '';
        }

        function deleteExpense(id) {
            if (!confirm('M√∂chtest du diese Ausgabe wirklich l√∂schen?')) return;

            const key = getStorageKey();
            const data = localStorage.getItem(key);
            const expenses = data ? JSON.parse(data) : [];

            const filtered = expenses.filter(exp => exp.id !== id);
            saveExpenses(filtered);
            loadExpenses();
        }

        function updateStats(expenses) {
            const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            document.getElementById('totalAmount').textContent = total.toFixed(2) + ' ‚Ç¨';
            document.getElementById('totalCount').textContent = expenses.length + ' Eintr√§ge';

            // Guthaben berechnen
            const budgetKey = getBudgetKey();
            const budget = parseFloat(localStorage.getItem(budgetKey)) || 0;
            const remaining = budget - total;
            const remainingCard = document.getElementById('remainingCard');

            if (budget > 0) {
                document.getElementById('remainingAmount').textContent = remaining.toFixed(2) + ' ‚Ç¨';
                document.getElementById('budgetSubtitle').textContent = `von ${budget.toFixed(2)} ‚Ç¨ Guthaben`;

                // Farbe √§ndern je nach Status
                if (remaining < 0) {
                    remainingCard.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                } else if (remaining < budget * 0.2) {
                    remainingCard.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                } else {
                    remainingCard.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                }
            } else {
                document.getElementById('remainingAmount').textContent = '- ‚Ç¨';
                document.getElementById('budgetSubtitle').textContent = 'Kein Guthaben festgelegt';
                remainingCard.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
            }

            // Kategorien-√úbersicht
            const categories = {};
            expenses.forEach(exp => {
                categories[exp.category] = (categories[exp.category] || 0) + exp.amount;
            });

            const categoryList = document.getElementById('categoryList');
            if (Object.keys(categories).length === 0) {
                categoryList.innerHTML = '<div style="color: #9ca3af; padding: 10px;">Keine Ausgaben</div>';
            } else {
                categoryList.innerHTML = Object.entries(categories)
                    .map(([cat, amount]) => `
                        <div class="category-item">
                            <span>${cat}</span>
                            <strong>${amount.toFixed(2)} ‚Ç¨</strong>
                        </div>
                    `).join('');
            }
        }

        function updateTable(expenses) {
            const tbody = document.getElementById('expensesTableBody');

            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Noch keine Ausgaben f√ºr diesen Monat erfasst</td></tr>';
                return;
            }

            tbody.innerHTML = expenses.map(exp => `
                <tr>
                    <td>${exp.category}</td>
                    <td>${exp.description || '-'}</td>
                    <td class="amount">${exp.amount.toFixed(2)} ‚Ç¨</td>
                    <td class="action-cell">
                        <button class="btn-red" onclick="deleteExpense(${exp.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function exportJSON() {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('expenses-')) {
                    allData[key] = JSON.parse(localStorage.getItem(key));
                }
            }

            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ausgaben-backup-${new Date().toISOString().slice(0, 10)}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    Object.keys(imported).forEach(key => {
                        localStorage.setItem(key, JSON.stringify(imported[key]));
                    });
                    loadExpenses();
                    alert('‚úÖ Daten erfolgreich importiert!');
                } catch (error) {
                    alert('‚ùå Fehler beim Importieren. Bitte √ºberpr√ºfe die Datei.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportCSV(allMonths) {
            let expenses = [];

            if (allMonths) {
                // Alle Monate
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('expenses-')) {
                        const month = key.replace('expenses-', '');
                        const data = JSON.parse(localStorage.getItem(key));
                        data.forEach(exp => {
                            expenses.push({ month, ...exp });
                        });
                    }
                }
            } else {
                // Nur aktueller Monat
                const key = getStorageKey();
                const data = localStorage.getItem(key);
                if (data) {
                    expenses = JSON.parse(data).map(exp => ({
                        month: monthSelect.value,
                        ...exp
                    }));
                }
            }

            if (expenses.length === 0) {
                alert('Keine Ausgaben vorhanden.');
                return;
            }

            const headers = ['Datum (Monat)', 'Kategorie', 'Beschreibung', 'Betrag (EUR)'];
            const rows = expenses.map(exp => [
                exp.month,
                exp.category,
                exp.description || '',
                exp.amount.toFixed(2)
            ]);

            const csvContent = [
                headers.join(';'),
                ...rows.map(row => row.join(';'))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = allMonths 
                ? `alle-ausgaben-${new Date().toISOString().slice(0, 10)}.csv`
                : `ausgaben-${monthSelect.value}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Enter-Taste im Amount-Feld
        document.getElementById('amountInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addExpense();
            }
        });
    </script>
</body>
</html>
